// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User Management (Extended Clerk)
// ============================================================================

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  firstName String
  lastName  String
  role      UserRole @default(USER)

  // Billing Information
  taxId            String?
  billingName      String?
  billingAddress   String?
  stripeCustomerId String? @unique

  // Relations
  restaurants   Restaurant[]
  menus         Menu[]
  reviews       Review[]
  favorites     Favorite[]
  bookings      Booking[]
  subscriptions Subscription[]
  invoices      Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
  @@index([email])
}

enum UserRole {
  ADMIN
  OWNER
  USER
}

// ============================================================================
// Restaurant Management
// ============================================================================

model Restaurant {
  id String @id @default(uuid())

  // Basic Info
  name        String
  slug        String @unique
  description String

  // Location
  address   String
  latitude  Float?
  longitude Float?

  // Status
  status RestaurantStatus @default(PENDING)

  // Media
  logoUrl  String?
  coverUrl String?

  // Details
  priceRange PriceRange
  phone      String?
  website    String?

  // Relations
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  menus               RestaurantMenu[]
  reviews             Review[]
  taxonomies          RestaurantTaxonomy[]
  openingHours        OpeningHour[]
  favorites           Favorite[]
  bookings            Booking[]
  tables              Table[]
  bookingServices     BookingService[]
  bookingReminder     BookingReminder?
  specialEvents       SpecialEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([status])
  @@index([slug])
}

enum RestaurantStatus {
  PENDING
  APPROVED
  REJECTED
  ARCHIVED
}

enum PriceRange {
  CHEAP
  MODERATE
  EXPENSIVE
  LUXURY
}

model OpeningHour {
  id        String  @id @default(uuid())
  dayOfWeek Int // 0-6 (Sunday-Saturday)
  openTime  String? // Format "HH:mm"
  closeTime String? // Format "HH:mm"
  isClosed  Boolean @default(false)

  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, dayOfWeek])
  @@index([restaurantId])
}

// ============================================================================
// Menu Management
// ============================================================================

model Menu {
  id String @id @default(uuid())

  // Basic Info
  title       String
  description String?
  price       Decimal? @db.Decimal(10, 2)
  isActive    Boolean  @default(true)

  // Relations
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  restaurants RestaurantMenu[]
  dishes      Dish[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([isActive])
}

model RestaurantMenu {
  restaurantId String
  menuId       String

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menu       Menu       @relation(fields: [menuId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([restaurantId, menuId])
  @@index([menuId])
}

// ============================================================================
// Dish Management
// ============================================================================

model Dish {
  id String @id @default(uuid())

  // Basic Info
  name        String
  description String?
  price       Decimal @db.Decimal(10, 2)
  imageUrl    String?

  // Allergens
  allergens String[]

  // Order
  order Int @default(0)

  // Relations
  menuId String
  menu   Menu   @relation(fields: [menuId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([menuId])
  @@index([order])
}

// ============================================================================
// Taxonomy (Categories/Tags)
// ============================================================================

model Taxonomy {
  id   String       @id @default(uuid())
  type TaxonomyType
  name String
  slug String

  // Relations
  restaurants RestaurantTaxonomy[]

  createdAt DateTime @default(now())

  @@unique([type, slug])
  @@index([type])
}

enum TaxonomyType {
  CUISINE_TYPE
  RESTAURANT_FEATURE
  DIETARY
  AMBIANCE
}

model RestaurantTaxonomy {
  restaurantId String
  taxonomyId   String

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  taxonomy   Taxonomy   @relation(fields: [taxonomyId], references: [id], onDelete: Cascade)

  @@id([restaurantId, taxonomyId])
  @@index([taxonomyId])
}

// ============================================================================
// Reviews & Ratings
// ============================================================================

model Review {
  id String @id @default(uuid())

  // Rating & Comment
  rating  Int      @db.SmallInt
  comment String
  photos  String[]

  // Relations
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([restaurantId, userId])
  @@index([restaurantId])
  @@index([userId])
  @@index([rating])
}

// ============================================================================
// Subscriptions & Billing
// ============================================================================

model Subscription {
  id String @id @default(uuid())

  // Dates
  startDate DateTime
  endDate   DateTime
  status    SubscriptionStatus

  // Stripe Info
  planId   String
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("EUR")

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  invoices Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([endDate])
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
}

model Invoice {
  id String @id @default(uuid())

  // Invoice Details
  number         String        @unique
  amountSubtotal Decimal       @db.Decimal(10, 2)
  taxAmount      Decimal       @db.Decimal(10, 2)
  taxRate        Decimal       @db.Decimal(5, 2)
  total          Decimal       @db.Decimal(10, 2)
  status         InvoiceStatus
  pdfUrl         String?

  // Relations
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  issuedAt DateTime @default(now())

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([issuedAt])
}

enum InvoiceStatus {
  PAID
  VOID
  REFUNDED
}

// ============================================================================
// Favorites (Social)
// ============================================================================

model Favorite {
  id String @id @default(uuid())

  // Relations
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, restaurantId])
  @@index([userId])
  @@index([restaurantId])
}

// ============================================================================
// Bookings (Reservations)
// ============================================================================

model Booking {
  id String @id @default(uuid())

  // Booking Details
  date         DateTime
  time         String // Format "HH:mm"
  partySize    Int    @db.SmallInt
  specialNotes String?

  // Contact Info
  customerName  String
  customerEmail String
  customerPhone String

  // Status
  status BookingStatus @default(PENDING)

  // Relations
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  tableId String?
  table   Table?  @relation(fields: [tableId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
  @@index([userId])
  @@index([tableId])
  @@index([status])
  @@index([date])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

// ============================================================================
// Table Management & Seating
// ============================================================================

model Table {
  id String @id @default(uuid())

  // Table Details
  tableNumber String // Ej: "1", "A1", "Terraza 3"
  capacity    Int    @db.SmallInt // Número de personas
  minCapacity Int    @default(1) @db.SmallInt // Mínimo de personas para esta mesa

  // Location & Type
  area     String? // Ej: "Interior", "Terraza", "Ventana", "VIP"
  shape    TableShape @default(SQUARE)
  isActive Boolean    @default(true) // Si la mesa está disponible para reservas

  // Visual Builder (posición en el layout visual)
  positionX Float? // Coordenada X en el builder
  positionY Float? // Coordenada Y en el builder
  rotation  Float? @default(0) // Rotación en grados

  // Relations
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  bookings              Booking[]
  specialEventTables    SpecialEventTable[]
  tableBlockSchedules   TableBlockSchedule[]
  tableAvailabilities   TableAvailability[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([restaurantId, tableNumber])
  @@index([restaurantId])
  @@index([isActive])
}

enum TableShape {
  SQUARE    // Cuadrada
  RECTANGLE // Rectangular
  ROUND     // Redonda
  BOOTH     // Reservado/Booth
}

// ============================================================================
// Sistema de Servicios y Turnos de Reserva
// ============================================================================

// Servicio de comida (Desayuno, Comida, Cena, etc.)
model BookingService {
  id String @id @default(uuid())

  // Información del servicio
  name        String // Ej: "Cena", "Comida", "Brunch"
  description String?
  daysOfWeek  Int[] // Array de días [0-6] donde está activo este servicio
  isActive    Boolean @default(true)

  // Relations
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  slots               BookingSlot[]
  tableAvailabilities TableAvailability[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
  @@index([isActive])
}

// Turno específico dentro de un servicio
model BookingSlot {
  id String @id @default(uuid())

  // Horario del turno
  startTime       String // Format "HH:mm" - Ej: "20:00"
  endTime         String // Format "HH:mm" - Ej: "21:30"
  durationMinutes Int    @default(90) // Duración en minutos
  maxCapacity     Int? // Capacidad máxima de personas para este turno (opcional)

  // Relations
  serviceId String
  service   BookingService @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceId])
}

// Disponibilidad de mesa para un día y servicio específico
model TableAvailability {
  id String @id @default(uuid())

  // Fecha y servicio
  date      DateTime // Solo fecha (sin hora)
  isAvailable Boolean @default(true) // Si está disponible para reservas

  // Relations
  tableId String
  table   Table @relation(fields: [tableId], references: [id], onDelete: Cascade)

  serviceId String
  service   BookingService @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tableId, date, serviceId])
  @@index([tableId])
  @@index([date])
  @@index([serviceId])
}

// Configuración de recordatorios para el owner
model BookingReminder {
  id String @id @default(uuid())

  // Configuración del recordatorio
  reminderTime String  @default("10:00") // Hora del recordatorio (HH:mm)
  isActive     Boolean @default(true)
  frequency    String  @default("DAILY") // DAILY, WEEKDAYS, WEEKENDS

  // Relations
  restaurantId String     @unique
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
}

// Eventos especiales que modifican la disposición de mesas
model SpecialEvent {
  id String @id @default(uuid())

  // Event Details
  name        String
  description String?
  eventDate   DateTime // Fecha del evento
  startTime   String? // Hora inicio del evento
  endTime     String? // Hora fin del evento

  // Configuration
  isRecurring    Boolean @default(false) // Si es recurrente
  recurringType  RecurringType?
  maxCapacity    Int? // Capacidad máxima para este evento

  // Relations
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  tables SpecialEventTable[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
  @@index([eventDate])
}

enum RecurringType {
  WEEKLY
  MONTHLY
  YEARLY
}

// Relación muchos a muchos entre eventos y mesas
model SpecialEventTable {
  id String @id @default(uuid())

  // Custom position for this event
  positionX Float?
  positionY Float?
  rotation  Float?

  // Relations
  eventId String
  event   SpecialEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  tableId String
  table   Table @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([eventId, tableId])
  @@index([eventId])
  @@index([tableId])
}

// Bloqueos de mesas por fecha/hora específica
model TableBlockSchedule {
  id String @id @default(uuid())

  // Block details
  blockDate DateTime
  startTime String // Format "HH:mm"
  endTime   String // Format "HH:mm"
  reason    String?

  // Relations
  tableId String
  table   Table @relation(fields: [tableId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tableId])
  @@index([blockDate])
}

// ============================================================================
// Page Builder (CMS)
// ============================================================================

model PageSection {
  id String @id @default(uuid())

  // Section configuration
  type     SectionType
  title    String?
  subtitle String?
  order    Int         @default(0)
  isActive Boolean     @default(true)

  // Configuration as JSON
  config Json // Stores filters, limits, styling, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([order])
  @@index([isActive])
}

enum SectionType {
  HERO
  CAROUSEL
  CTA
  FEATURED_GRID
  CATEGORY_BANNER
  CUSTOM_HTML
}

// ============================================================================
// Audit Log (Optional)
// ============================================================================

model AuditLog {
  id String @id @default(uuid())

  action   String
  entity   String
  entityId String
  userId   String?
  changes  Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}
